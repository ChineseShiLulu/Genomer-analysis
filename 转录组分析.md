# RNA SNP calling pipeline


## 1 STAR比对

### 1 建参考基因组索引
```
STAR --runThreadN 6 --runMode genomeGenerate \
                    --genomeDir /home/sll/genome-sheep/Oar_rambouillet_v1.0-STAR \
                    --genomeFastaFiles GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                    --sjdbGTFfile GCF_002742125.1_Oar_rambouillet_v1.0_genomic.gtf \
                    --sjdbOverhang 149

--runThreadN：                线程数。
--runMode genomeGenerate：    构建基因组索引。
--genomeDir：                 索引目录。（需提前建好）
--genomeFastaFiles：          基因组文件。
--sjdbGTFfile：               基因组注释文件。
--sjdbOverhang：              reads长度减1
```
### 2 比对(若用于GATK，可不排序输出sam文件）
#### 1常规比对（一次2个吧, 用于差异分析）
```
STAR --runThreadN 10 --genomeDir /home/sll/genome-sheep/Oar_rambouillet_v1.0-STAR \
                     --readFilesIn SRR17709920_1.filter.fastq.gz SRR17709920_2.filter.fastq.gz \
                     --readFilesCommand gunzip -c \
                     --outFileNamePrefix ./starmap.bam/SRR17709920

--readFilesIn ：             paired reads文件
--outSAMtype ：              表示输出默认排序的bam文件，类似于samtools sort（还有--outSAMtype BAM Unsorted和--outSAMtype BAM Unsorted SortedByCoordinate）
--outFileNamePrefix ：       输出文件路径即前缀
```
#### 2 2-pass模式（用于RNA数据的GATK--call_snp）

1. 常规比对
```
STAR --runThreadN 10 --genomeDir /home/sll/genome-sheep/Oar_rambouillet_v1.0-STAR \
                     --readFilesIn SRR17709920_1.filter.fastq.gz SRR17709920_2.filter.fastq.gz \
                     --readFilesCommand gunzip -c \
                     --outFileNamePrefix ./starmap.bam/SRR17709920

--readFilesIn ：             paired reads文件
--outSAMtype ：              表示输出默认排序的bam文件，类似于samtools sort（还有--outSAMtype BAM Unsorted和--outSAMtype BAM Unsorted SortedByCoordinate）
--outFileNamePrefix ：       输出文件路径即前缀
``` 
2. 建立样品索引，--sjdbFileChrStartEnd参数将所有样品的SJ.out.tab文件作为输入的annotated junction进行第二次建index。
```
STAR --runThreadN 20 --runMode genomeGenerate \
                     --genomeDir ./index \
                     --genomeFastaFiles /home/sll/genome-sheep/Oar_rambouillet_v1.0-STAR/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                     --sjdbGTFfile /home/sll/genome-sheep/Oar_rambouillet_v1.0-STAR/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.gtf \
                     --sjdbFileChrStartEnd *.out.tab --sjdbOverhang 149

./index  新建的索引目录 
```
3. 第二次比对，用第二次建立的index再一次对每个样品进行STAR比对
```
STAR --runThreadN 10 --genomeDir ./starmap.bam/index \
                     --readFilesIn SRR17709920_1.filter.fastq.gz SRR17709920_2.filter.fastq.gz \
                     --readFilesCommand gunzip -c \
                     --outFileNamePrefix ./starmap.bam/2_pass/SRR17709920_2pass

--readFilesCommand gunzip -c   如果使用的是.gz文件，则加此参数
######注：常规的差异分析、可变剪接分析建议使用HISAT2软件，这破软件好烦，如果是要用RNA数据call SNP那就使用它的2-pass模式，毕竟是GATK官网推荐的软件。
```

## 2 picard加头排序标记重复
### 1 加头并排序
单样品示例
```
java -jar -Xmx15g /home/software/picard/build/libs/picard.jar AddOrReplaceReadGroups I=SRR17709911_2passAligned.out.sam \
                                                                                     O=./sample_RNA_SNP_calling/SRR17709911_sort_added.bam \
                                                                                     SO=coordinate \
                                                                                     RGID=SRR17709911 \
                                                                                     RGLB=mRNA \
                                                                                     RGPL=illumina \
                                                                                     RGPU=NovaSeq6000 \
                                                                                     RGSM=SRR17709911
```
全部样品一起（PS:这一步可以一起跑，不太占内存,）
```
ls *sort.bam | cut -d"_" -f 1 | sort -u | while read id ;
do (nohup java -jar -Xmx15g /home/software/picard/build/libs/picard.jar AddOrReplaceReadGroups I=${id}_sort.bam \
                                                                                               O=./sample_RNA_SNP_calling/${id}_sort_added.bam \
                                                                                               SO=coordinate \
                                                                                               RGID=${id} \
                                                                                               RGLB=mRNA \
                                                                                               RGPL=illumina \
                                                                                               RGPU=NovaSeq6000 \
                                                                                               RGSM=${id} &) ;
done
```
### 2 标记重复
单样品示例
```
java -jar /home/software/picard/build/libs/picard.jar MarkDuplicates I=SRR17709911_sort_added.bam \
                                                                     O=SRR17709911.sorted.addhead.markdup.bam \
                                                                     M=SRR17709911.sorted.addhead.markdup.metrics.txt \
                                                                     CREATE_INDEX=true VALIDATION_STRINGENCY=SILENT
```
全部样品一起（PS:悠着点，一般64G运存的一次跑4个就行了，不然服务器崩了别怪我）
```
ls *sort_added.bam | cut -d"_" -f 1 | sort -u | while read id ;
do (nohup java -jar /home/software/picard/build/libs/picard.jar MarkDuplicates I=${id}_sort_added.bam \
                                                                               O=${id}.sorted.addhead.markdup.bam M=${id}.sorted.addhead.markdup.metrics.txt \
                                                                               CREATE_INDEX=true \
                                                                               VALIDATION_STRINGENCY=SILENT &) ;
done
```                                                                               
## 3 SplitNCigarReads                                                                           
* `-- Split N trim and reassign mapping qualities`不是单纯提取splitbam而是将所有bam转化成GATK可识别的格式
* 这一步是`RNA-seq`特异性的一步。因为`mRNA`转录本是主要由`DNA`的外显子`exon`可变剪切组合而成

单样品示例
```
/home/software/gatk-4.1.4.0/gatk SplitNCigarReads -R /home/sheep-reference/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                                                  -I SRR17709911.sorted.addhead.markdup.bam \
                                                  -O SRR17709911.sorted.addhead.markdup.split.bam
```
全部样品一起（PS:一次最多4个）
```
ls *markdup.bam | cut -d"." -f 1 | sort -u  | while read id ;
do (nohup /home/software/gatk-4.1.4.0/gatk SplitNCigarReads -R /home/sheep-reference/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                                                            -I ${id}.sorted.addhead.markdup.bam \
                                                            -O ${id}.sorted.addhead.markdup.split.bam &) ;
done
```
## 4 变异检测HaplotypeCaller 
单样品示例
```
/home/software/gatk-4.1.4.0/gatk HaplotypeCaller -R /home/sheep-reference/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                                                 --output-mode EMIT_ALL_CONFIDENT_SITES \
                                                 --dont-use-soft-clipped-bases \
                                                 -stand-call-conf 20 \
                                                 -ERC GVCF \
                                                 -I SRR17709911.sorted.addhead.markdup.split.bam \
                                                 -O SRR17709911.gvcf.gz

--output-mode                     EMIT_ALL_CONFIDENT_SITES
--dont-use-soft-clipped-bases     表示GATK不考虑比对时产生的soft clipped的碱基，以减少假阳性和假阴性的变异
-stand-call-conf                  相当于一个可信度打分，转录的默认是20，全基因组会考虑用30
-ERC GVCF                         输出gvcf方便后续的合并
```
全部样品一起（PS:一次最多4个）
```
ls *markdup.split.bam | cut -d"." -f 1 | sort -u | while read id ;
do (nohup /home/software/gatk-4.1.4.0/gatk HaplotypeCaller -R /home/sheep-reference/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                                                           --output-mode EMIT_ALL_CONFIDENT_SITES \
                                                           -ERC GVCF \
                                                           --dont-use-soft-clipped-bases \
                                                           -stand-call-conf 20 \
                                                           -I ${id}.sorted.addhead.markdup.split.bam \
                                                           -O ${id}.gvcf.gz &) ;
done
```
## 5 合并GVCF文件
```
nohup /home/software/gatk-4.1.4.0/gatk  CombineGVCFs  -R /home/sheep-reference/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                                                      -V SRR17709910.gvcf.gz \
                                                      -V SRR17709911.gvcf.gz \
                                                      -V SRR17709912.gvcf.gz \
                                                      -O  combined.vcf &

-V            要合并的gvcf文件
-O            输出的vcf文件名称
```
## 6 GenotypeGVCFs
```
/home/software/gatk-4.1.4.0/gatk  GenotypeGVCFs -R /home/sheep-reference/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                                                -V combined.vcf  \
                                                -O combined.genotype.vcf
```
## 7 提取SNP位点
```
/home/software/gatk-4.1.4.0/gatk  SelectVariants  --select-type  SNP  \
                                                  -V combined.genotype.vcf \
                                                  -O combined.genotype.snp.vcf
```
## 8 硬过滤
RNA数据不支持`VQSR`,使用 `FS > 30.0 & QD < 2.0`，GATK建议过滤掉在`35bp`范围内出现3个以上的SNP的情况（`-window 35 -cluster 3`）推荐命令
```
/home/software/gatk-4.1.4.0/gatk VariantFiltration -R /home/sheep-reference/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                                                   -V combined.genotype.snp.vcf \
                                                   -O combined.genotype.snp.filter.vcf \
                                                   --window 35 --cluster 3 \
                                                   --filter-name "FS>30.0" --filter-expression "FS>30.0" \
                                                   --filter-name "QD<2.0" --filter-expression "QD<2.0" 
```
## 9 提取pass位点
```
/home/software/gatk-4.1.4.0/gatk SelectVariants --exclude-filtered \
                                                -R /home/sheep-reference/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                                                -V combined.genotype.snp.filter.vcf \
                                                -O combined.genotype.snp.filter.retain.vcf
```

# 差异表达分析
## 1 文件下载

```
# 单个文件
wget -c -t 0 -O SRR13107018.sra https://sra-pub-run-odp.s3.amazonaws.com/sra/SRR13107018/SRR13107018

#-c -t 配合使用可以防止下载数据的过程中链接中断的问题，-O则可以指定下载路径和文件名。

# 多个文件一起下
/home/software/sratoolkit.2.9.6-1-centos_linux64/bin/prefetch -O ./ --option-file SRR_Acc_List.txt

```
## 2 循环把下载的所有sra文件都变为`fastq`(双端测序数据使用`--split-3` )
```
ls *sra | while read id ;
do (nohup /home/software/sratoolkit.2.9.6-1-centos_linux64/bin/fastq-dump --gzip --split-3 $id &) ;
done
```

## 3 `fastp`质量控制
```
ls *fastq.gz | cut -d"_" -f 1 |sort -u | while read id ;
do (nohup fastp -i ${id}_1.fastq.gz -I ${id}_2.fastq.gz -g -q 5 -n 15 -l 150 -u 50 -o ${id}_1.filter.fastq.gz -O ${id}_2.filter.fastq.gz -h ${id}.fastp.html &) ;
done

# 去除带接头(adapter)的双端读长(默认开启，可用-A关闭)；
# 去掉单端读长中含 N(N 表示无法确定碱基信息)的碱基比例大于10%部分（默认开启）
# -q 设置碱基质量阈值，默认是15，phred质量评分≥Q15
# -n 一条read中N碱基的数量超过了多少个，那么这条read就被删除，默认是5（即这条read里有5个N）
# -g 进行PolyG尾的去除
# -u 允许百分之多少的碱基不合格（0-100），默认是40（就是说40%），超过这个比例，整条read就被删除
# -l read小于这个参数设定长度会被丢弃或删除，默认是15,由你的测序bp决定
# -j, --json	输出的json报告文件名，以“.json”结尾
# -h, --html	输出的html报告文件名，以“.html”结尾
```
## 4 参考基因组下载及建索引-如已有，忽略此步
由于使用`hisat2`进行序列比对，因此也用它建索引
```
## 下载基因组序列
mkdir -p  genome/ARS-UCD1.2  && cd genome/ARS-UCD1.2
nohup wget https://ftp.ncbi.nlm.nih.gov/genomes/all/GCF/002/263/795/GCF_002263795.1_ARS-UCD1.2/GCF_002263795.1_ARS-UCD1.2_genomic.fna.gz &  
gunzip GCF_002263795.1_ARS-UCD1.2_genomic.fna.gz

## 下载gtf文件并解压
wget https://ftp.ncbi.nlm.nih.gov/genomes/refseq/vertebrate_mammalian/Bos_taurus/latest_assembly_versions/GCF_002263795.1_ARS-UCD1.2/GCF_002263795.1_ARS-UCD1.2_genomic.gtf.gz
gunzip GCF_002263795.1_ARS-UCD1.2_genomic.gtf.gz

## 建索引（hisat2软件）
mkdir index & cd index
nohup hisat2-build -p 4 GCF_002263795.1_ARS-UCD1.2_genomic.fna  GCF_002263795.1_ARS-UCD1.2_genomic > hisat2.log &
```
## 5 reads mapping到参考基因组-----hisat2
```
mkdir hismap.sam

ls *filter.fastq.gz|cut -d"_" -f 1 |sort -u | while read id ;
do (nohup hisat2 -p 8 -x /home/sll/genome-cattle/ARS-UCD1.2/GCF_002263795.1_ARS-UCD1.2_genomic -1 ${id}_1.filter.fastq.gz -2 ${id}_2.filter.fastq.gz -S hismap.sam/${id}.hismap.sam &) ;
done


#绵羊参考基因组
/home/sll/genome-sheep/Oar_rambouillet_v1.0-ncbi/GCF_002742125.1_Oar_rambouillet_v1.0_genomic
#牛参考基因组
/home/sll/genome-cattle/ARS-UCD1.2/GCF_002263795.1_ARS-UCD1.2_genomic
# -p:          线程数
# -x:          基因组索引前缀。所下的基因组索引为多个文件，索引前缀到genome为止。
# -1/-2:       fastq输入文件。当输入为单端测序时使用-U 指定输入。单端或双端的输入都可使用逗号分隔输入多个样本，或使用多次-1 -2 / -U 指定多个输入。e.g.: -U sample1.fq.gz,sample2.fq.gz -U sample3.fq.gz
# -S:          输出sam文件路径。
```
## 6 转为bam文件并排序
```
cd hisout.sam

ls *sam | cut -d"." -f 1 |sort -u | while read id ;
do (nohup samtools view -S ${id}.hismap.sam -b > ${id}.hismap.bam &) ;
done

ls *hismap.bam | cut -d"." -f 1 |sort -u | while read id ;
do (nohup samtools sort -@ 8 ${id}.hismap.bam -o ${id}_sort.bam &) ;
done

# sort:        进行排序
# -@:          线程数
# -o:          输出bam文件
#              最后一项为输入文件
```

## 7 为`sort.bam`文件建索引
```
ls *sort.bam | cut -d"_" -f 1 | sort -u | while read id ;
do (nohup samtools index ${id}_sort.bam ${id}_sort.bam.index &) ;
done

## 使用samtools index建立索引，使之快速访问bam文件
```
## 8 `faturecount`计数定量
```
nohup featureCounts -p -t exon -g gene_id -M -T 8 \
                    -a /home/sll/genome-cattle/ARS-UCD1.2/GCF_002263795.1_ARS-UCD1.2_genomic.gtf \
                    -o all.featurecounts.txt \
                    *_sort.bam &


#绵羊gtf文件
/home/sll/genome-sheep/Oar_rambouillet_v1.0-ncbi/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.gtf
#牛gtf文件
/home/sll/genome-cattle/ARS-UCD1.2/GCF_002263795.1_ARS-UCD1.2_genomic.gtf
#  featureCounts 进行定量，统计比对在这个基因的坐标上的read数
# -t             设置feature-type，-t指定的必须是gtf中有的feature，同时read只有落到这些feature上才会被统计到，默认是“exon”
# -p             双端数据时需要
# -a             转录组注释文件
# -o             输出文件

##报错处理
cat GCF_002263795.1_ARS-UCD1.2_genomic.gtf | grep gene_id | wc -w             #检查原始gtf注释文件gene_id个数
cat GCF_002263795.1_ARS-UCD1.2_genomic.gtf | grep gene_id\ \"\"\; | wc -w     #检查空gene_id值的行数
sed -i -e '/gene_id\ \"\"\;/d' GCF_002263795.1_ARS-UCD1.2_genomic.gtf         #删除包括空gene_id值的行 
cat GCF_002263795.1_ARS-UCD1.2_genomic.gtf | grep gene_id\ \"\"\; | wc -w     #修改后的检查一下 检查包括空gene_id值的行 0为已删除掉
```
## 9 对featureCounts的结果进行整合，html文件可视化
```
multiqc all.featurecounts.txt.summary -o  all.counts.summary
```

## 10 提取定量信息
```
awk -F '\t' '{print $1,$7,$8,$9,$10,$11,$12}' OFS='\t' all.featurecounts.txt > all_fcount.matrix.txt

# 1列为基因id，7列及以后为样本定量信息
# \t 表示以制表符分割开来
```

## 11 将矩阵导入R中，采用`DESeq2`进行差异分析













                                                                            
                                                                               
                                                                               
