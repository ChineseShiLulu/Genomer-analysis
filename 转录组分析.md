# RNA SNP calling pipeline


## 1 STAR比对

### 1 建参考基因组索引
```
STAR --runThreadN 6 --runMode genomeGenerate \
                    --genomeDir /home/sll/genome-sheep/Oar_rambouillet_v1.0-STAR \
                    --genomeFastaFiles GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                    --sjdbGTFfile GCF_002742125.1_Oar_rambouillet_v1.0_genomic.gtf \
                    --sjdbOverhang 149

--runThreadN：                线程数。
--runMode genomeGenerate：    构建基因组索引。
--genomeDir：                 索引目录。（需提前建好）
--genomeFastaFiles：          基因组文件。
--sjdbGTFfile：               基因组注释文件。
--sjdbOverhang：              reads长度减1
```
### 2 比对(若用于GATK，可不排序输出sam文件）
#### 1常规比对（一次2个吧, 用于差异分析）
```
STAR --runThreadN 10 --genomeDir /home/sll/genome-sheep/Oar_rambouillet_v1.0-STAR \
                     --readFilesIn SRR17709920_1.filter.fastq.gz SRR17709920_2.filter.fastq.gz \
                     --readFilesCommand gunzip -c \
                     --outFileNamePrefix ./starmap.bam/SRR17709920

--readFilesIn ：             paired reads文件
--outSAMtype ：              表示输出默认排序的bam文件，类似于samtools sort（还有--outSAMtype BAM Unsorted和--outSAMtype BAM Unsorted SortedByCoordinate）
--outFileNamePrefix ：       输出文件路径即前缀
```
#### 2 2-pass模式（用于RNA数据的GATK--call_snp）

1. 常规比对
```
STAR --runThreadN 10 --genomeDir /home/sll/genome-sheep/Oar_rambouillet_v1.0-STAR \
                     --readFilesIn SRR17709920_1.filter.fastq.gz SRR17709920_2.filter.fastq.gz \
                     --readFilesCommand gunzip -c \
                     --outFileNamePrefix ./starmap.bam/SRR17709920

--readFilesIn ：             paired reads文件
--outSAMtype ：              表示输出默认排序的bam文件，类似于samtools sort（还有--outSAMtype BAM Unsorted和--outSAMtype BAM Unsorted SortedByCoordinate）
--outFileNamePrefix ：       输出文件路径即前缀
``` 
2. 建立样品索引，--sjdbFileChrStartEnd参数将所有样品的SJ.out.tab文件作为输入的annotated junction进行第二次建index。
```
STAR --runThreadN 20 --runMode genomeGenerate \
                     --genomeDir ./index \
                     --genomeFastaFiles /home/sll/genome-sheep/Oar_rambouillet_v1.0-STAR/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                     --sjdbGTFfile /home/sll/genome-sheep/Oar_rambouillet_v1.0-STAR/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.gtf \
                     --sjdbFileChrStartEnd *.out.tab --sjdbOverhang 149

./index  新建的索引目录 
```
3. 第二次比对，用第二次建立的index再一次对每个样品进行STAR比对
```
STAR --runThreadN 10 --genomeDir ./starmap.bam/index \
                     --readFilesIn SRR17709920_1.filter.fastq.gz SRR17709920_2.filter.fastq.gz \
                     --readFilesCommand gunzip -c \
                     --outFileNamePrefix ./starmap.bam/2_pass/SRR17709920_2pass

--readFilesCommand gunzip -c   如果使用的是.gz文件，则加此参数
######注：常规的差异分析、可变剪接分析建议使用HISAT2软件，这破软件好烦，如果是要用RNA数据call SNP那就使用它的2-pass模式，毕竟是GATK官网推荐的软件。
```

## 2 picard加头排序标记重复
### 1 加头并排序
单样品示例
```
java -jar -Xmx15g /home/software/picard/build/libs/picard.jar AddOrReplaceReadGroups I=SRR17709911_2passAligned.out.sam \
                                                                                     O=./sample_RNA_SNP_calling/SRR17709911_sort_added.bam \
                                                                                     SO=coordinate \
                                                                                     RGID=SRR17709911 \
                                                                                     RGLB=mRNA \
                                                                                     RGPL=illumina \
                                                                                     RGPU=NovaSeq6000 \
                                                                                     RGSM=SRR17709911
```
全部样品一起（PS:这一步可以一起跑，不太占内存,）
```
ls *sort.bam | cut -d"_" -f 1 | sort -u | while read id ;
do (nohup java -jar -Xmx15g /home/software/picard/build/libs/picard.jar AddOrReplaceReadGroups I=${id}_sort.bam \
                                                                                               O=./sample_RNA_SNP_calling/${id}_sort_added.bam \
                                                                                               SO=coordinate \
                                                                                               RGID=${id} \
                                                                                               RGLB=mRNA \
                                                                                               RGPL=illumina \
                                                                                               RGPU=NovaSeq6000 \
                                                                                               RGSM=${id} &) ;
done
```
### 2 标记重复
单样品示例
```
java -jar /home/software/picard/build/libs/picard.jar MarkDuplicates I=SRR17709911_sort_added.bam \
                                                                     O=SRR17709911.sorted.addhead.markdup.bam \
                                                                     M=SRR17709911.sorted.addhead.markdup.metrics.txt \
                                                                     CREATE_INDEX=true VALIDATION_STRINGENCY=SILENT
```
全部样品一起（PS:悠着点，一般64G运存的一次跑4个就行了，不然服务器崩了别怪我）
```
ls *sort_added.bam | cut -d"_" -f 1 | sort -u | while read id ;
do (nohup java -jar /home/software/picard/build/libs/picard.jar MarkDuplicates I=${id}_sort_added.bam \
                                                                               O=${id}.sorted.addhead.markdup.bam M=${id}.sorted.addhead.markdup.metrics.txt \
                                                                               CREATE_INDEX=true \
                                                                               VALIDATION_STRINGENCY=SILENT &) ;
done
```                                                                               
## 3 SplitNCigarReads                                                                           
* `-- Split N trim and reassign mapping qualities`不是单纯提取splitbam而是将所有bam转化成GATK可识别的格式
* 这一步是`RNA-seq`特异性的一步。因为`mRNA`转录本是主要由`DNA`的外显子`exon`可变剪切组合而成

单样品示例
```
/home/software/gatk-4.1.4.0/gatk SplitNCigarReads -R /home/sheep-reference/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                                                  -I SRR17709911.sorted.addhead.markdup.bam \
                                                  -O SRR17709911.sorted.addhead.markdup.split.bam
```
全部样品一起（PS:一次最多4个）
```
ls *markdup.bam | cut -d"." -f 1 | sort -u  | while read id ;
do (nohup /home/software/gatk-4.1.4.0/gatk SplitNCigarReads -R /home/sheep-reference/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                                                            -I ${id}.sorted.addhead.markdup.bam \
                                                            -O ${id}.sorted.addhead.markdup.split.bam &) ;
done
```
## 4 变异检测HaplotypeCaller 
单样品示例
```
/home/software/gatk-4.1.4.0/gatk HaplotypeCaller -R /home/sheep-reference/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                                                 --output-mode EMIT_ALL_CONFIDENT_SITES \
                                                 --dont-use-soft-clipped-bases \
                                                 -stand-call-conf 20 \
                                                 -ERC GVCF \
                                                 -I SRR17709911.sorted.addhead.markdup.split.bam \
                                                 -O SRR17709911.gvcf.gz

--output-mode                     EMIT_ALL_CONFIDENT_SITES
--dont-use-soft-clipped-bases     表示GATK不考虑比对时产生的soft clipped的碱基，以减少假阳性和假阴性的变异
-stand-call-conf                  相当于一个可信度打分，转录的默认是20，全基因组会考虑用30
-ERC GVCF                         输出gvcf方便后续的合并
```
全部样品一起（PS:一次最多4个）
```
ls *markdup.split.bam | cut -d"." -f 1 | sort -u | while read id ;
do (nohup /home/software/gatk-4.1.4.0/gatk HaplotypeCaller -R /home/sheep-reference/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                                                           --output-mode EMIT_ALL_CONFIDENT_SITES \
                                                           -ERC GVCF \
                                                           --dont-use-soft-clipped-bases \
                                                           -stand-call-conf 20 \
                                                           -I ${id}.sorted.addhead.markdup.split.bam \
                                                           -O ${id}.gvcf.gz &) ;
done
```
## 5 合并GVCF文件
```
nohup /home/software/gatk-4.1.4.0/gatk  CombineGVCFs  -R /home/sheep-reference/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                                                      -V SRR17709910.gvcf.gz \
                                                      -V SRR17709911.gvcf.gz \
                                                      -V SRR17709912.gvcf.gz \
                                                      -O  combined.vcf &

-V            要合并的gvcf文件
-O            输出的vcf文件名称
```
## 6 GenotypeGVCFs
```
/home/software/gatk-4.1.4.0/gatk  GenotypeGVCFs -R /home/sheep-reference/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                                                -V combined.vcf  \
                                                -O combined.genotype.vcf
```
## 7 提取SNP位点
```
/home/software/gatk-4.1.4.0/gatk  SelectVariants  --select-type  SNP  \
                                                  -V combined.genotype.vcf \
                                                  -O combined.genotype.snp.vcf
```
## 8 硬过滤
RNA数据不支持`VQSR`,使用 `FS > 30.0 & QD < 2.0`，GATK建议过滤掉在`35bp`范围内出现3个以上的SNP的情况（`-window 35 -cluster 3`）推荐命令
```
/home/software/gatk-4.1.4.0/gatk VariantFiltration -R /home/sheep-reference/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                                                   -V combined.genotype.snp.vcf \
                                                   -O combined.genotype.snp.filter.vcf \
                                                   --window 35 --cluster 3 \
                                                   --filter-name "FS>30.0" --filter-expression "FS>30.0" \
                                                   --filter-name "QD<2.0" --filter-expression "QD<2.0" 
```
## 9 提取pass位点
```
/home/software/gatk-4.1.4.0/gatk SelectVariants --exclude-filtered \
                                                -R /home/sheep-reference/GCF_002742125.1_Oar_rambouillet_v1.0_genomic.fna \
                                                -V combined.genotype.snp.filter.vcf \
                                                -O combined.genotype.snp.filter.retain.vcf
```















                                                                            
                                                                               
                                                                               
